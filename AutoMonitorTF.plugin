#!name = TestFlight ç›‘æŽ§ (ç»ˆæžç‰ˆ)
#!desc = ç›‘æŽ§ TF åé¢ã€‚ä¿å­˜åŽï¼Œè¯·åŠ¡å¿…åœ¨ Loon çš„ã€Œè„šæœ¬ã€é¡µé¢ç‚¹å‡»ã€ŒTFç›‘æŽ§(ç‚¹å‡»æµ‹è¯•)ã€æ¥éªŒè¯ã€‚
#!author = fmz200 (Modified by Gemini)
#!icon = https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png
#!tag = ç›‘æŽ§

[Argument]
# è¿™é‡Œçš„ ids å¯¹åº”ä¸‹é¢çš„ {ids}
ids = input,"899247664",tag=App ID,desc=è¾“å…¥IDï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš” (å¦‚: 899247664,12345678)

# è¿™é‡Œçš„ cron_time å¯¹åº”ä¸‹é¢çš„ {cron_time}
cron_time = input,"0 */10 * * * *",tag=ç›‘æŽ§é¢‘çŽ‡,desc=Cronè¡¨è¾¾å¼ (é»˜è®¤æ¯10åˆ†é’Ÿ)

[Script]
# 1. æ‰‹åŠ¨æµ‹è¯•å…¥å£ï¼šä¿å­˜åŽåŽ» Loon -> è„šæœ¬ -> æ‰¾åˆ° "TFç›‘æŽ§(ç‚¹å‡»æµ‹è¯•)" ç‚¹å‡»è¿è¡Œ
generic script-content=, tag=TFç›‘æŽ§(ç‚¹å‡»æµ‹è¯•), timeout=10, argument={ids}, img-url=https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png

# 2. å®šæ—¶ä»»åŠ¡å…¥å£ï¼šæ ¹æ®è®¾ç½®çš„æ—¶é—´è‡ªåŠ¨åŽå°è¿è¡Œ
cron {cron_time} script-content=, tag=TFç›‘æŽ§(åŽå°), timeout=60, argument={ids}

// ================= è„šæœ¬é€»è¾‘ =================
// è„šæœ¬å°†åŒæ—¶ä½œä¸º script-content è¿è¡Œ
/**
 * TestFlight Monitor
 */

// ç«‹å³æ‰“å°æ—¥å¿—ï¼Œè¯æ˜Žè„šæœ¬å·²åŠ è½½
console.log("ðŸ”” TestFlight ç›‘æŽ§è„šæœ¬å·²å¯åŠ¨...");

const $ = new Env('TFç›‘æŽ§');

// èŽ·å–å‚æ•°ï¼šä¼˜å…ˆå– argumentï¼Œå–ä¸åˆ°åˆ™ä¸ºç©º
let TF_APP_ID = "";
if (typeof $argument !== "undefined" && $argument) {
    TF_APP_ID = $argument;
    console.log(`â„¹ï¸ è¯»å–åˆ°å¯è§†åŒ–å‚æ•°: ${TF_APP_ID}`);
} else {
    console.log("âš ï¸ æœªè¯»å–åˆ°å‚æ•°ï¼Œå°è¯•è¯»å–æœ¬åœ°é…ç½®...");
    TF_APP_ID = $.getdata("fmz200_TF_APP_ID");
}

const userAgents = [
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36",
  "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1"
];

!(async () => {
    // 1. éªŒè¯ ID æ˜¯å¦å­˜åœ¨
    if (!TF_APP_ID) {
        console.log("âŒ é”™è¯¯: æœªæ£€æµ‹åˆ° IDã€‚è¯·åœ¨æ’ä»¶é…ç½®ä¸­å¡«å†™ App IDã€‚");
        $.msg("TFç›‘æŽ§é…ç½®é”™è¯¯", "æœªå¡« App ID", "è¯·ç‚¹å‡»æ’ä»¶é…ç½®æŒ‰é’®è¿›è¡Œå¡«å†™");
        $.done();
        return;
    }

    // 2. æ ¼å¼åŒ– ID
    const appIds = TF_APP_ID.split(/\s*[\n,]\s*/).filter(Boolean);
    if (appIds.length === 0) {
        console.log("âŒ é”™è¯¯: ID åˆ—è¡¨è§£æžä¸ºç©º");
        $.done();
        return;
    }
    
    console.log(`ðŸ” å‡†å¤‡ç›‘æŽ§ ${appIds.length} ä¸ª App...`);

    // 3. å¾ªçŽ¯æ‰§è¡Œæ£€æŸ¥
    for (const item of appIds) {
        // è§£æž ID å’Œ å¤‡æ³¨ (æ ¼å¼: ID#å¤‡æ³¨)
        let appId = item;
        let appName = "";
        if (item.includes("#")) {
            const parts = item.split("#");
            appId = parts[0].trim();
            appName = parts[1].trim();
        }

        await checkTF(appId, appName, item);
        
        // ç®€å•å»¶è¿Ÿ
        await $.wait(1000);
    }

    console.log("âœ… æ‰€æœ‰æ£€æŸ¥ç»“æŸ");
    $.done();
})();

async function checkTF(appId, appName, originalStr) {
    const url = `https://testflight.apple.com/join/${appId}`;
    const headers = { 
        'User-Agent': userAgents[Math.floor(Math.random() * userAgents.length)],
        'Accept-Language': 'zh-CN,zh-Hans;q=0.9'
    };

    return new Promise(resolve => {
        $.get({url, headers}, (err, resp, data) => {
            if (err) {
                console.log(`âŒ [${originalStr}] è¯·æ±‚å¤±è´¥: ${err}`);
                resolve();
                return;
            }
            if (!resp || resp.status !== 200) {
                const code = resp ? resp.status : "æœªçŸ¥";
                console.log(`âŒ [${originalStr}] å“åº”å¼‚å¸¸ (Code: ${code})`);
                // å¦‚æžœæ˜¯ 404ï¼Œé€šå¸¸æ˜¯ ID å¡«é”™äº†
                if (code === 404) console.log("ðŸ‘‰ è¯·æ£€æŸ¥ ID æ˜¯å¦æ­£ç¡®");
                resolve();
                return;
            }

            // æ£€æŸ¥é€»è¾‘
            const isFull = /ç‰ˆæœ¬çš„æµ‹è¯•å‘˜å·²æ»¡|This beta is full/i.test(data);
            const isClosed = /ä¸æŽ¥å—ä»»ä½•æ–°æµ‹è¯•å‘˜|not accepting any new testers/i.test(data);
            const isOpen = /è¦åŠ å…¥ Beta ç‰ˆ|To join the/i.test(data);

            if (isOpen) {
                console.log(`ðŸŸ¢ [${originalStr}] ===> å¯åŠ å…¥ï¼`);
                const title = appName ? `[${appName}] å¯åŠ å…¥` : `TestFlight å¯åŠ å…¥`;
                const body = `ID: ${appId} (ç‚¹å‡»é€šçŸ¥è·³è½¬)`;
                
                // å‘é€é€šçŸ¥
                $.msg(title, body, url, {
                    "open-url": url
                });
            } else if (isFull) {
                console.log(`ðŸ”´ [${originalStr}] å·²æ»¡`);
            } else if (isClosed) {
                console.log(`â›”ï¸ [${originalStr}] åœæ­¢æ‹›å‹Ÿ`);
            } else {
                console.log(`âšªï¸ [${originalStr}] æœªçŸ¥çŠ¶æ€`);
            }
            resolve();
        });
    });
}

// é€‚é… Loon çš„ç®€æ˜“çŽ¯å¢ƒç±»
function Env(t){return new class{constructor(t){this.name=t}getdata(t){return $persistentStore.read(t)}msg(t,e,s,i){$notification.post(t,e,s,i)}get(t,e){$httpClient.get(t,e)}wait(t){return new Promise(e=>setTimeout(e,t))}done(){$done()}}(t)}
