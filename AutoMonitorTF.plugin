#!name = TestFlight ç›‘æŽ§
#!desc = ç›‘æŽ§ TestFlight æ˜¯å¦æœ‰åé¢ï¼Œæ”¯æŒå¯è§†åŒ–é…ç½® AppIDã€‚
#!openUrl = https://github.com/fmz200/wool_scripts
#!author = fmz200 (Modified by Gemini)
#!icon = https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png

[Argument]
TF_IDS = {
  type = "text",
  title = "TestFlight ID åˆ—è¡¨",
  desc = "è¯·è¾“å…¥ App IDï¼Œå¤šä¸ª ID ç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ã€‚ä¾‹å¦‚ï¼š899247664, 12345678",
  placeholder = "899247664, 12345678",
  auto-close = false
}

[Script]
# å®šæ—¶ä»»åŠ¡ï¼šé»˜è®¤æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
# æ ¼å¼ï¼šç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨
cron "0 */10 * * * *" script-content=

// ================= è„šæœ¬é€»è¾‘å¼€å§‹ =================
/**
 * TestFlight ç›‘æŽ§æ’ä»¶ (Loon é€‚é…ç‰ˆ)
 * 1. æ”¯æŒé€šè¿‡æ’ä»¶é…ç½®ç•Œé¢ç›´æŽ¥è¾“å…¥ ID
 * 2. ç§»é™¤ç³»ç»Ÿé™åˆ¶ï¼Œä¿®å¤ä¸å…¼å®¹é—®é¢˜
 */

const $ = new Env('ç›‘æŽ§TestFlightæ˜¯å¦å¯åŠ å…¥');
const isNode = $.isNode();
const notify = isNode ? require('./sendNotify') : '';
$.nodeNotifyMsg = [];

// ===========================================
// æ ¸å¿ƒé€»è¾‘ï¼šè¯»å– Loon å¯è§†åŒ–å‚æ•°
// ===========================================
let TF_APP_ID = "";

if (typeof $argument !== "undefined" && $argument) {
    // ä¼˜å…ˆè¯»å–æ’ä»¶é…ç½®çš„å‚æ•°
    TF_APP_ID = $argument;
} else {
    // åªæœ‰åœ¨ Node çŽ¯å¢ƒæˆ–æŒä¹…åŒ–å­˜å‚¨ä¸­æ‰è¯»å–æ—§é…ç½®
    TF_APP_ID = isNode ? process.env["fmz200_TF_APP_ID"] : $.getdata("fmz200_TF_APP_ID");
}

const userAgents = [
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 13_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
  "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1"
];

!(async () => {
  if (!TF_APP_ID) {
    console.log("âš ï¸ è­¦å‘Šï¼šæœªæ£€æµ‹åˆ° App ID");
    console.log("â„¹ï¸ è¯·åœ¨ Loon æ’ä»¶é…ç½® -> [TestFlight ID åˆ—è¡¨] ä¸­å¡«å…¥ ID");
    await sendMsg("TestFlight ç›‘æŽ§é…ç½®é”™è¯¯", "è¯·åœ¨æ’ä»¶è®¾ç½®ä¸­å¡«å…¥ App ID");
    $.done();
    return;
  }
  
  // å¤„ç†åˆ†éš”ç¬¦ï¼šæ”¯æŒæ¢è¡Œã€é€—å·
  const appIds = TF_APP_ID.split(/\s*[\n,]\s*/).filter(Boolean);
  
  console.log(`ðŸ” å¼€å§‹ç›‘æŽ§ä»¥ä¸‹ App ID: ${appIds.join(", ")}`);
  
  for (const appIdInfo of appIds) {
    let appId = appIdInfo;
    let appName = null;
    
    // æ”¯æŒ "ID#å¤‡æ³¨" æ ¼å¼
    if (appIdInfo.includes("#")) {
      const parts = appIdInfo.split("#");
      appId = parts[0].trim();
      appName = parts[1].trim();
    }
    
    await autoPost(appId, appName, appIdInfo);
    
    // ç®€å•çš„éšæœºå»¶è¿Ÿï¼Œé¿å…å¹¶å‘è¿‡é«˜
    await $.wait(Math.floor(Math.random() * 2000) + 1000); 
  }

  if (isNode && $.nodeNotifyMsg.length > 0) {
      await sendMsg($.nodeNotifyMsg.join("\n"), "");
  }
  
  console.log("âœ… æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•");
  $.done();
})();

async function autoPost(appId, appName, appIdInfo) {
  const url = `https://testflight.apple.com/join/${appId}`;
  const headers = {
    'User-Agent': getRandomUA(),
    'Accept-Language': 'zh-CN,zh-Hans;q=0.9'
  };

  return new Promise((resolve) => {
    $.get({url: url, headers: headers}, async (error, resp, data) => {
      if (error) {
        console.log(`âŒ [${appIdInfo}] è¯·æ±‚å¤±è´¥: ${error}`);
        resolve();
        return;
      }
      
      if (resp.status === 404) {
        console.log(`âŒ [${appIdInfo}] é“¾æŽ¥æ— æ•ˆ (404)`);
        resolve();
        return;
      }

      // çŠ¶æ€åˆ¤æ–­é€»è¾‘
      const isFull = /ç‰ˆæœ¬çš„æµ‹è¯•å‘˜å·²æ»¡|This beta is full/i.test(data);
      const isClosed = /ç‰ˆæœ¬ç›®å‰ä¸æŽ¥å—ä»»ä½•æ–°æµ‹è¯•å‘˜|This beta isn't accepting any new testers/i.test(data);
      const isOpen = /è¦åŠ å…¥ Beta ç‰ˆ|To join the/i.test(data);

      if (isFull) {
        console.log(`ðŸ”´ [${appIdInfo}] å·²æ»¡å‘˜`);
      } else if (isClosed) {
        console.log(`â›”ï¸ [${appIdInfo}] åœæ­¢æ‹›å‹Ÿ`);
      } else if (isOpen) {
        console.log(`ðŸŸ¢ [${appIdInfo}] ===> åé¢å·²å¼€æ”¾ï¼`);
        const title = appName ? `[${appName}] å¯åŠ å…¥ TestFlight` : `[${appId}] å¯åŠ å…¥ TestFlight`;
        const body = `ç‚¹å‡»é€šçŸ¥è·³è½¬åŠ å…¥ã€‚\nID: ${appId}`;
        
        // å‘é€ Loon é€šçŸ¥
        await sendMsg(title, {
            "open-url": url,
            "media-url": "https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png"
        }, body); // body ä¼ ç»™ msg å‡½æ•°
        
      } else {
        console.log(`âšªï¸ [${appIdInfo}] æœªçŸ¥çŠ¶æ€ (HTTP ${resp.status})`);
      }
      resolve();
    });
  });
}

function getRandomUA() {
  return userAgents[Math.floor(Math.random() * userAgents.length)];
}

// é€‚é… Loon çš„ç®€æ˜“é€šçŸ¥å‘é€å‡½æ•°
async function sendMsg(title, opts, body = "") {
    if ($.isNode()) {
        await notify.sendNotify($.name, title + "\n" + body);
    } else {
        // Loon é€šçŸ¥çš„å‚æ•°é¡ºåº: title, subtitle, content, options
        $.msg($.name, title, body, opts);
    }
}

// åŸºç¡€çŽ¯å¢ƒç±» (ç²¾ç®€ç‰ˆ)
function Env(t,e){class s{constructor(t){this.env=t}send(t,e="GET"){t="string"==typeof t?{url:t}:t;let s=this.get;"POST"===e&&(s=this.post);const i=new Promise(((e,i)=>{s.call(this,t,((t,s,o)=>{t?i(t):e(s)}))}));return t.timeout?((t,e=1e3)=>Promise.race([t,new Promise(((t,s)=>{setTimeout((()=>{s(new Error("è¯·æ±‚è¶…æ—¶"))}),e)}))]))(i,t.timeout):i}get(t){return this.send.call(this.env,t)}post(t){return this.send.call(this.env,t,"POST")}}return new class{constructor(t,e){this.name=t,this.http=new s(this),this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.isNeedRewrite=!1,this.logSeparator="\n",this.encoding="utf-8",this.startTime=(new Date).getTime(),Object.
