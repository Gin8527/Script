#!name = TestFlight ç›‘æŽ§
#!desc = ç›‘æŽ§ TestFlight åé¢ã€‚å®‰è£…åŽç‚¹å‡»æ’ä»¶çš„â€œé…ç½®â€æˆ–é½¿è½®å›¾æ ‡ï¼Œå¯è®¾ç½® AppID å’Œ è¿è¡Œé¢‘çŽ‡ã€‚
#!author = fmz200 (Modified by Gemini)
#!icon = https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png
#!tag = TestFlight,ç›‘æŽ§

[Argument]
# è¿™é‡Œçš„ ids å¯¹åº”ä¸‹é¢ Script ä¸­çš„ {ids}
ids = input,"899247664",tag=App ID åˆ—è¡¨,desc=è¾“å…¥ App IDï¼Œå¤šä¸ª ID ç”¨é€—å·åˆ†éš” (ä¾‹å¦‚: 899247664,12345678)

# è¿™é‡Œçš„ cron_time å¯¹åº”ä¸‹é¢ Script ä¸­çš„ {cron_time}
cron_time = input,"0 */10 * * * *",tag=è¿è¡Œé¢‘çŽ‡ (Cron),desc=è®¾ç½®æ£€æŸ¥æ—¶é—´ï¼Œé»˜è®¤æ¯ 10 åˆ†é’Ÿ (æ ¼å¼: ç§’ åˆ† æ—¶ æ—¥ æœˆ å‘¨)

[Script]
# æ ¸å¿ƒæ”¹åŠ¨ï¼šä½¿ç”¨ {cron_time} å¼•ç”¨ä¸Šæ–¹å®šä¹‰çš„å‚æ•°ï¼Œå®žçŽ°æ—¶é—´å¯é…ç½®
# ä½¿ç”¨ argument={ids} å°†ä¸Šæ–¹å®šä¹‰çš„ App ID ä¼ ç»™è„šæœ¬
cron {cron_time} script-content=, tag=TFç›‘æŽ§, timeout=60, argument={ids}

// ================= è„šæœ¬å†…å®¹å¼€å§‹ =================
/**
 * TestFlight ç›‘æŽ§æ’ä»¶
 */
const $ = new Env('TFç›‘æŽ§');

// èŽ·å–æ’ä»¶ä¼ å…¥çš„ argument å‚æ•°
// æ ¹æ® Loon æ–‡æ¡£ï¼Œargument={ids} ä¼šæŠŠç”¨æˆ·è¾“å…¥çš„å€¼ä½œä¸ºå­—ç¬¦ä¸²ä¼ è¿›æ¥
let TF_APP_ID = "";

if (typeof $argument !== "undefined") {
    TF_APP_ID = $argument;
}

const userAgents = [
  "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36",
  "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1"
];

!(async () => {
    // 1. æ£€æŸ¥å‚æ•°
    if (!TF_APP_ID) {
        console.log("âš ï¸ æœªæ£€æµ‹åˆ° App ID");
        // å¦‚æžœæ˜¯æ‰‹åŠ¨è¿è¡Œæˆ–ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæç¤ºç”¨æˆ·
        $.msg($.name, "âš ï¸ é…ç½®ç¼ºå¤±", "è¯·ç‚¹å‡»æ’ä»¶çš„ã€Œé…ç½®ã€æŒ‰é’®å¡«å†™ TestFlight ID");
        $.done();
        return;
    }

    // 2. å¤„ç† ID åˆ—è¡¨ (æ”¯æŒæ¢è¡Œæˆ–é€—å·)
    const appIds = TF_APP_ID.split(/\s*[\n,]\s*/).filter(Boolean);
    console.log(`ðŸ” å¼€å§‹ç›‘æŽ§ä»¥ä¸‹ ID: ${appIds.join(", ")}`);

    // 3. å¾ªçŽ¯æ‰§è¡Œ
    for (const item of appIds) {
        let appId = item;
        let appName = "";
        
        // æ”¯æŒ "ID#å¤‡æ³¨" æ ¼å¼
        if (item.includes("#")) {
            const parts = item.split("#");
            appId = parts[0].trim();
            appName = parts[1].trim();
        }

        await checkTF(appId, appName, item);
        
        // éšæœºå»¶è¿Ÿé˜²æ­¢å°ç¦
        await $.wait(Math.floor(Math.random() * 2000) + 1000);
    }

    console.log("âœ… æ‰€æœ‰ç›‘æŽ§ä»»åŠ¡å®Œæˆ");
    $.done();
})();

async function checkTF(appId, appName, originalStr) {
    const url = `https://testflight.apple.com/join/${appId}`;
    const headers = { 
        'User-Agent': userAgents[Math.floor(Math.random() * userAgents.length)],
        'Accept-Language': 'zh-CN,zh-Hans;q=0.9'
    };

    return new Promise(resolve => {
        $.get({url, headers}, (err, resp, data) => {
            if (err) {
                console.log(`âŒ [${originalStr}] ç½‘ç»œé”™è¯¯: ${err}`);
                resolve();
                return;
            }
            if (resp.status === 404) {
                console.log(`âŒ [${originalStr}] é“¾æŽ¥æ— æ•ˆ (404)`);
                resolve();
                return;
            }

            // çŠ¶æ€åˆ¤å®šé€»è¾‘
            const isFull = /ç‰ˆæœ¬çš„æµ‹è¯•å‘˜å·²æ»¡|This beta is full/i.test(data);
            const isClosed = /ä¸æŽ¥å—ä»»ä½•æ–°æµ‹è¯•å‘˜|not accepting any new testers/i.test(data);
            const isOpen = /è¦åŠ å…¥ Beta ç‰ˆ|To join the/i.test(data);

            if (isOpen) {
                console.log(`ðŸŸ¢ [${originalStr}] ===> åé¢å·²å¼€æ”¾ï¼`);
                const title = appName ? `[${appName}] TF æœ‰åé¢äº†` : `TestFlight å¯åŠ å…¥`;
                const body = `ID: ${appId}\nç‚¹å‡»æ­¤é€šçŸ¥ç›´æŽ¥è·³è½¬åŠ å…¥`;
                
                // å‘é€ç³»ç»Ÿé€šçŸ¥
                $.msg(title, body, url, {
                    "open-url": url,
                    "media-url": "https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/TestFlight_01.png"
                });
            } else if (isFull) {
                console.log(`ðŸ”´ [${originalStr}] å·²æ»¡`);
            } else if (isClosed) {
                console.log(`â›”ï¸ [${originalStr}] åœæ­¢æ‹›å‹Ÿ`);
            } else {
                console.log(`âšªï¸ [${originalStr}] æœªçŸ¥çŠ¶æ€ (Code: ${resp.status})`);
            }
            resolve();
        });
    });
}

// æžç®€ç‰ˆ Env å·¥å…·ç±» (é€‚é… Loon)
function Env(t){return new class{constructor(t){this.name=t}getdata(t){return $persistentStore.read(t)}msg(t,e,s,i){$notification.post(t,e,s,i)}get(t,e){$httpClient.get(t,e)}wait(t){return new Promise(e=>setTimeout(e,t))}done(){$done()}}(t)}
